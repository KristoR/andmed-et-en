name: Discover thesis terms

on:
  schedule:
    # Run on the 1st of each month at 06:00 UTC
    - cron: '0 6 1 * *'
  workflow_dispatch:
    inputs:
      full_run:
        description: 'Full historical run (ignore saved state)'
        required: false
        default: 'false'
        type: boolean
      from_date:
        description: 'Start date (YYYY-MM-DD), only used with full_run'
        required: false
        default: '2015-01-01'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  harvest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --group harvest

      - name: Install spaCy model
        run: uv pip install en_core_web_sm@https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.8.0/en_core_web_sm-3.8.0-py3-none-any.whl

      - name: Fetch theses
        id: fetch
        run: |
          ARGS="--verbose"
          if [ "${{ github.event.inputs.full_run }}" = "true" ]; then
            ARGS="$ARGS --full --from-date ${{ github.event.inputs.from_date }}"
          fi
          uv run python scripts/fetch_theses.py $ARGS 2>&1 | tee harvest_output.txt

      - name: Promote candidates
        run: uv run python scripts/promote_candidates.py

      - name: Regenerate glossary
        run: uv run python scripts/generate_glossary.py

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet data/terms.yml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add thesis-discovered terms"
          title: "Add thesis-discovered terms (${{ github.run_id }})"
          body: |
            ## Automated thesis term discovery

            This PR was generated by the scheduled thesis harvest workflow.

            ### Changes
            - Fetched new thesis metadata from Estonian university repositories
            - Promoted high-confidence candidate terms to the glossary
            - Regenerated glossary pages

            ### Harvest output
            ```
            $(cat harvest_output.txt | tail -30)
            ```

            ### Review checklist
            - [ ] Review promoted terms in `data/terms.yml`
            - [ ] Check that Estonian translations are correct
            - [ ] Remove any terms that don't belong in a data glossary
          branch: automated/thesis-terms
          delete-branch: true
          add-paths: |
            data/terms.yml
            data/candidate_terms.yml
            data/harvest_state.json
            docs/index.md
            docs/terms/
